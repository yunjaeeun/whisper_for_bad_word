<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OpenVidu 백엔드 연동 테스트</title>
  <!-- OpenVidu 브라우저 라이브러리 CDN (버전은 필요에 따라 변경) -->
  <script src="https://unpkg.com/openvidu-browser@2.25.0/dist/openvidu-browser.min.js"></script>
  <style>
    /* 비디오 화면 스타일 */
    #localVideo video, #remoteVideos video {
      width: 300px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>OpenVidu 백엔드 연동 테스트</h1>
  <button id="joinBtn">세션 참여</button>
  <button id="leaveBtn" disabled>세션 나가기</button>
  <div id="videos">
    <!-- 자신의 스트림이 표시될 영역 -->
    <div id="localVideo"></div>
    <!-- 다른 참가자의 스트림이 표시될 영역 -->
    <div id="remoteVideos"></div>
  </div>

  <script>
    let OV;
    let session;
    let publisher;

    // 백엔드 서버의 URL (필요에 따라 수정)
    const BACKEND_URL = 'http://localhost:8090';

    document.getElementById('joinBtn').addEventListener('click', joinSession);
    document.getElementById('leaveBtn').addEventListener('click', leaveSession);

    function joinSession() {
      // 백엔드에서 토큰(및 필요한 경우 sessionId) 요청
      // 예제에서는 roomName과 clientData를 함께 전송하는 예시입니다.
      fetch(BACKEND_URL + '/api/sessions/get-token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ roomName: 'demo-room', clientData: '사용자' })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('토큰 요청 실패');
        }
        return response.json();
      })
      .then(data => {
        // 백엔드에서 발급받은 토큰 사용
        const token = data.token;

        // OpenVidu 객체 및 세션 생성
        OV = new OpenVidu();
        session = OV.initSession();

        // 다른 참가자가 스트림을 publish하면 subscribe
        session.on('streamCreated', (event) => {
          const subscriber = session.subscribe(event.stream, 'remoteVideos');
          subscriber.on('videoElementCreated', (event) => {
            event.element.style.width = '300px';
          });
        });

        // 세션에 연결 (토큰과 함께 clientData 전달)
        session.connect(token, { clientData: '사용자' })
          .then(() => {
            // 연결 후 자신의 미디어 스트림 publish
            publisher = OV.initPublisher('localVideo', {
              audioSource: undefined,   // 기본 마이크 사용
              videoSource: undefined,   // 기본 카메라 사용
              publishAudio: true,
              publishVideo: true,
              mirror: true
            });
            session.publish(publisher);

            // 버튼 상태 업데이트
            document.getElementById('joinBtn').disabled = true;
            document.getElementById('leaveBtn').disabled = false;
          })
          .catch(error => {
            console.error('세션 연결 중 오류 발생:', error);
          });
      })
      .catch(error => {
        console.error('토큰 발급 요청 중 오류 발생:', error);
      });
    }

    function leaveSession() {
      if (session) {
        session.disconnect();
      }
      // UI 초기화
      document.getElementById('joinBtn').disabled = false;
      document.getElementById('leaveBtn').disabled = true;
      document.getElementById('localVideo').innerHTML = '';
      document.getElementById('remoteVideos').innerHTML = '';
    }
  </script>
</body>
</html>
